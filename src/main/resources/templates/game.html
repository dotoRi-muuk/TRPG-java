<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRPG ìŠ¤í‚¬ ì‹œë®¬ë ˆì´í„°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .section {
            background: #f8f9fa;
            padding: 25px;
            margin-bottom: 25px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }
        
        .section h2 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 600;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1.1em;
            transition: border-color 0.3s;
            background: white;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group select {
            cursor: pointer;
        }

        .form-group select option {
            padding: 10px;
        }
        
        .btn {
            padding: 14px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            width: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .result-box {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            display: none;
        }
        
        .result-box.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .result-title {
            font-weight: 600;
            color: #667eea;
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        
        .result-content {
            color: #495057;
            line-height: 1.8;
            white-space: pre-wrap;
            font-family: 'Consolas', 'Monaco', monospace;
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .result-summary {
            margin-top: 15px;
            padding: 15px;
            background: #e8f4fd;
            border-radius: 8px;
        }
        
        .result-summary .stat {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 5px;
        }
        
        .result-summary .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .result-summary .stat-value {
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }
        
        .highlight {
            background: #fff3cd;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .success {
            color: #28a745;
            font-weight: 600;
        }
        
        .failure {
            color: #dc3545;
            font-weight: 600;
        }
        
        .params-section {
            display: none;
        }
        
        .params-section.show {
            display: block;
        }
        
        .param-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .param-item {
            margin-bottom: 10px;
        }

        .param-item label {
            display: block;
            margin-bottom: 5px;
            color: #495057;
            font-weight: 500;
            font-size: 0.95em;
        }

        .param-item input[type="number"],
        .param-item input[type="text"],
        .param-item select {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 1em;
        }

        .param-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            font-weight: bold;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âš”ï¸ TRPG ìŠ¤í‚¬ ì‹œë®¬ë ˆì´í„°</h1>
        <p class="subtitle">ì§ì—…êµ°ê³¼ ìŠ¤í‚¬ì„ ì„ íƒí•˜ì—¬ ë°ë¯¸ì§€ë¥¼ ê³„ì‚°í•˜ì„¸ìš”</p>
        
        <!-- Step 1: Primary Class Selection -->
        <div class="section">
            <h2><span class="step-number">1</span> ì§ì—…êµ° ì„ íƒ</h2>
            <div class="form-group">
                <label for="primaryClass">ì§ì—…êµ°ì„ ì„ íƒí•˜ì„¸ìš”</label>
                <select id="primaryClass" onchange="loadSubclasses()">
                    <option value="">-- ì§ì—…êµ° ì„ íƒ --</option>
                </select>
            </div>
        </div>
        
        <!-- Step 2: Subclass Selection -->
        <div class="section">
            <h2><span class="step-number">2</span> ì§ì—… ì„ íƒ</h2>
            <div class="form-group">
                <label for="subclass">ì§ì—…ì„ ì„ íƒí•˜ì„¸ìš”</label>
                <select id="subclass" onchange="loadSkills()" disabled>
                    <option value="">-- ë¨¼ì € ì§ì—…êµ°ì„ ì„ íƒí•˜ì„¸ìš” --</option>
                </select>
            </div>
        </div>
        
        <!-- Step 3: Skill Selection -->
        <div class="section">
            <h2><span class="step-number">3</span> ìŠ¤í‚¬ ì„ íƒ</h2>
            <div class="form-group">
                <label for="skill">ìŠ¤í‚¬ì„ ì„ íƒí•˜ì„¸ìš”</label>
                <select id="skill" onchange="loadParameters()" disabled>
                    <option value="">-- ë¨¼ì € ì§ì—…ì„ ì„ íƒí•˜ì„¸ìš” --</option>
                </select>
            </div>
        </div>
        
        <!-- Step 4: Parameters -->
        <div class="section params-section" id="paramsSection">
            <h2><span class="step-number">4</span> ìŠ¤í‚¬ ì¸ì ì…ë ¥</h2>
            <div class="param-grid" id="paramsContainer">
                <!-- Parameters will be dynamically added here -->
            </div>
        </div>
        
        <!-- Execute Button -->
        <div class="section">
            <button id="executeBtn" onclick="executeSkill()" class="btn btn-primary" disabled>
                ğŸ¯ ìŠ¤í‚¬ ì‹¤í–‰
            </button>
        </div>
        
        <!-- Result -->
        <div id="resultBox" class="result-box">
            <div class="result-title">ğŸ“Š ì‹¤í–‰ ê²°ê³¼</div>
            <div class="result-content" id="resultContent"></div>
            <div class="result-summary" id="resultSummary"></div>
        </div>
    </div>
    
    <script>
        // Store current skills data
        let currentSkills = [];
        let currentParameters = [];

        // Load primary classes on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadPrimaryClasses();
        });

        function loadPrimaryClasses() {
            fetch('/api/classes')
                .then(response => response.json())
                .then(classes => {
                    const select = document.getElementById('primaryClass');
                    select.innerHTML = '<option value="">-- ì§ì—…êµ° ì„ íƒ --</option>';
                    classes.forEach(cls => {
                        const option = document.createElement('option');
                        option.value = cls;
                        option.textContent = cls;
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading classes:', error);
                    alert('ì§ì—…êµ° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
        }

        function loadSubclasses() {
            const primaryClass = document.getElementById('primaryClass').value;
            const subclassSelect = document.getElementById('subclass');
            const skillSelect = document.getElementById('skill');
            const paramsSection = document.getElementById('paramsSection');
            const executeBtn = document.getElementById('executeBtn');
            
            // Reset downstream selections
            subclassSelect.innerHTML = '<option value="">-- ì§ì—… ì„ íƒ --</option>';
            skillSelect.innerHTML = '<option value="">-- ë¨¼ì € ì§ì—…ì„ ì„ íƒí•˜ì„¸ìš” --</option>';
            skillSelect.disabled = true;
            paramsSection.classList.remove('show');
            executeBtn.disabled = true;
            document.getElementById('resultBox').classList.remove('show');

            if (!primaryClass) {
                subclassSelect.disabled = true;
                return;
            }

            subclassSelect.disabled = false;
            
            fetch(`/api/classes/${encodeURIComponent(primaryClass)}/subclasses`)
                .then(response => response.json())
                .then(subclasses => {
                    subclasses.forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub;
                        option.textContent = sub;
                        subclassSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading subclasses:', error);
                    alert('ì§ì—… ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
        }

        function loadSkills() {
            const subclass = document.getElementById('subclass').value;
            const skillSelect = document.getElementById('skill');
            const paramsSection = document.getElementById('paramsSection');
            const executeBtn = document.getElementById('executeBtn');
            
            // Reset downstream selections
            skillSelect.innerHTML = '<option value="">-- ìŠ¤í‚¬ ì„ íƒ --</option>';
            paramsSection.classList.remove('show');
            executeBtn.disabled = true;
            document.getElementById('resultBox').classList.remove('show');

            if (!subclass) {
                skillSelect.disabled = true;
                return;
            }

            skillSelect.disabled = false;
            
            fetch(`/api/subclasses/${encodeURIComponent(subclass)}/skills`)
                .then(response => response.json())
                .then(skills => {
                    currentSkills = skills;
                    skills.forEach(skill => {
                        const option = document.createElement('option');
                        option.value = skill.methodName;
                        option.textContent = skill.displayName;
                        skillSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading skills:', error);
                    alert('ìŠ¤í‚¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
        }

        function loadParameters() {
            const skillName = document.getElementById('skill').value;
            const paramsSection = document.getElementById('paramsSection');
            const paramsContainer = document.getElementById('paramsContainer');
            const executeBtn = document.getElementById('executeBtn');
            
            document.getElementById('resultBox').classList.remove('show');

            if (!skillName) {
                paramsSection.classList.remove('show');
                executeBtn.disabled = true;
                return;
            }

            // Find the selected skill
            const skill = currentSkills.find(s => s.methodName === skillName);
            if (!skill) return;

            currentParameters = skill.parameters;
            paramsContainer.innerHTML = '';

            if (skill.parameters.length === 0) {
                paramsSection.classList.remove('show');
            } else {
                skill.parameters.forEach(param => {
                    const item = document.createElement('div');
                    item.className = 'param-item';
                    
                    if (param.type === 'boolean') {
                        item.innerHTML = `
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="param_${param.name}" name="${param.name}">
                                <label for="param_${param.name}">${param.displayName}</label>
                            </div>
                        `;
                    } else if (param.type === 'int') {
                        item.innerHTML = `
                            <label for="param_${param.name}">${param.displayName}</label>
                            <input type="number" id="param_${param.name}" name="${param.name}" value="10">
                        `;
                    } else if (param.type === 'double') {
                        item.innerHTML = `
                            <label for="param_${param.name}">${param.displayName}</label>
                            <input type="number" step="0.1" id="param_${param.name}" name="${param.name}" value="0.5">
                        `;
                    } else if (param.type.startsWith('enum:')) {
                        const enumName = param.type.split(':')[1];
                        let options = getEnumOptions(enumName);
                        item.innerHTML = `
                            <label for="param_${param.name}">${param.displayName}</label>
                            <select id="param_${param.name}" name="${param.name}">
                                ${options.map(o => `<option value="${o.value}">${o.label}</option>`).join('')}
                            </select>
                        `;
                    } else {
                        item.innerHTML = `
                            <label for="param_${param.name}">${param.displayName}</label>
                            <input type="text" id="param_${param.name}" name="${param.name}">
                        `;
                    }
                    
                    paramsContainer.appendChild(item);
                });
                paramsSection.classList.add('show');
            }
            
            executeBtn.disabled = false;
        }

        function getEnumOptions(enumName) {
            // Handle MasterArcherPassive enum
            if (enumName === 'MasterArcherPassive') {
                return [
                    { value: 'NONE', label: 'ì—†ìŒ' },
                    { value: 'POWER_SHOT', label: 'íŒŒì›Œìƒ·' },
                    { value: 'SPLIT_ARROW', label: 'ë¶„ì—´ í™”ì‚´' },
                    { value: 'PENETRATING_ARROW', label: 'ê´€í†µ í™”ì‚´' },
                    { value: 'EXPLOSIVE_ARROW', label: 'í­íƒ„ í™”ì‚´' },
                    { value: 'DOUBLE_SHOT', label: 'ë”ë¸” ìƒ·' }
                ];
            }
            return [{ value: '', label: 'ì„ íƒ' }];
        }

        function executeSkill() {
            const subclass = document.getElementById('subclass').value;
            const skill = document.getElementById('skill').value;
            
            if (!subclass || !skill) return;

            // Collect parameters
            const params = {};
            currentParameters.forEach(param => {
                const element = document.getElementById(`param_${param.name}`);
                if (element) {
                    if (param.type === 'boolean') {
                        params[param.name] = element.checked;
                    } else if (param.type === 'int') {
                        params[param.name] = parseInt(element.value) || 0;
                    } else if (param.type === 'double') {
                        params[param.name] = parseFloat(element.value) || 0.0;
                    } else {
                        params[param.name] = element.value;
                    }
                }
            });

            // Execute skill
            const executeBtn = document.getElementById('executeBtn');
            executeBtn.disabled = true;
            executeBtn.textContent = 'ì‹¤í–‰ ì¤‘...';

            fetch('/api/execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    subclass: subclass,
                    skill: skill,
                    params: params
                })
            })
            .then(response => response.json())
            .then(result => {
                const resultBox = document.getElementById('resultBox');
                const resultContent = document.getElementById('resultContent');
                const resultSummary = document.getElementById('resultSummary');
                
                if (result.success && result.data) {
                    resultContent.textContent = result.data.output || 'ê²°ê³¼ ì—†ìŒ';
                    
                    let summaryHtml = '';
                    if (result.data.damageDealt !== undefined && result.data.damageDealt !== 0) {
                        summaryHtml += `<span class="stat"><span class="stat-label">ê°€í•œ ë°ë¯¸ì§€: </span><span class="stat-value highlight">${result.data.damageDealt}</span></span>`;
                    }
                    if (result.data.damageTaken !== undefined && result.data.damageTaken !== 0) {
                        summaryHtml += `<span class="stat"><span class="stat-label">ë°›ì€ ë°ë¯¸ì§€: </span><span class="stat-value">${result.data.damageTaken}</span></span>`;
                    }
                    if (result.data.succeeded !== undefined) {
                        const successClass = result.data.succeeded ? 'success' : 'failure';
                        const successText = result.data.succeeded ? 'ì„±ê³µ' : 'ì‹¤íŒ¨';
                        summaryHtml += `<span class="stat"><span class="stat-label">íŒì •: </span><span class="stat-value ${successClass}">${successText}</span></span>`;
                    }
                    if (result.data.manaUsed !== undefined && result.data.manaUsed !== 0) {
                        summaryHtml += `<span class="stat"><span class="stat-label">ë§ˆë‚˜ ì†Œëª¨: </span><span class="stat-value">${result.data.manaUsed}</span></span>`;
                    }
                    if (result.data.staminaUsed !== undefined && result.data.staminaUsed !== 0) {
                        summaryHtml += `<span class="stat"><span class="stat-label">ìŠ¤íƒœë¯¸ë‚˜ ì†Œëª¨: </span><span class="stat-value">${result.data.staminaUsed}</span></span>`;
                    }
                    
                    resultSummary.innerHTML = summaryHtml || '<span class="stat-label">ì¶”ê°€ ì •ë³´ ì—†ìŒ</span>';
                    resultSummary.style.display = summaryHtml ? 'block' : 'none';
                } else {
                    resultContent.textContent = result.message || 'ì‹¤í–‰ ì˜¤ë¥˜';
                    resultSummary.innerHTML = '';
                    resultSummary.style.display = 'none';
                }
                
                resultBox.classList.add('show');
            })
            .catch(error => {
                console.error('Error executing skill:', error);
                const resultBox = document.getElementById('resultBox');
                const resultContent = document.getElementById('resultContent');
                resultContent.textContent = 'ìŠ¤í‚¬ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                resultBox.classList.add('show');
            })
            .finally(() => {
                executeBtn.disabled = false;
                executeBtn.textContent = 'ğŸ¯ ìŠ¤í‚¬ ì‹¤í–‰';
            });
        }
    </script>
</body>
</html>
